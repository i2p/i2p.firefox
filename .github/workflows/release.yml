name: Release

#on: [push]

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - '*.*.*' # Release 1.2.3

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            changelog.txt
          sparse-checkout-cone-mode: false
      - name: sleep 15 minutes
        run: |
          echo "sleeping 15 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 14 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 13 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 12 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 11 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 10 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 9 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 8 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 7 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 6 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 5 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 4 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 3 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 2 minutes to wait for artifacts"
          sleep 1m
          echo "sleeping 1 minutes to wait for artifacts"
          sleep 1m
      - name: Download artifacts
        id: download-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          skip_unpack: true
          workflow: ant.yml
          if_no_artifact_found: fail
      # remove .zip file extension
      - run: for f in *.zip; do mv "$f" "${f%.zip}"; done
      - run: echo "" | tee -a changelog.txt
      - run: echo "## Checksums" | tee -a changelog.txt
      - run: echo "" | tee -a changelog.txt
      - run: echo '```' | tee -a changelog.txt
      - run: sha256sum * | tee -a changelog.txt
      - run: echo '```' | tee -a changelog.txt
      - run: echo "" | tee -a changelog.txt
      - name: Upload artifacts
        uses: ncipollo/release-action@v1
        with:
          artifacts: "*"
          bodyFile: "changelog.txt"
